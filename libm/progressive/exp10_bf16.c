#include <math.h>
#include "progressive/float_prog_lib.h"
#include "progressive/expconsts.h"

double rlibm_prog_bf16_exp10(float x) {
    float_x fx;
    fx.f = x;
    
    // Take care of special cases
    if (0x421a209b <= fx.x && fx.x <= 0xb25e5bd8) {
        if (fx.x <= 0x7F800000) return 1.0/0.0;
        if (fx.x < 0x80000000) return 0.0/0.0;
        return 1.0;
    }
    
    if (fx.x <= 0x32de5bd8) {
        return 1.0;
    }
    
    if (fx.x >= 0xc2349e36) {
        if (fx.x <= 0xFF800000) return 0.0;
        return 0.0/0.0;
    }
    
    // Perform range reduction
    double xp = x * 2.12603398072791179629348334856331348419189453125e+02;
    int N = (int)xp;
    int N2 = N % 64;
    if (N2 < 0) N2 += 64;
    int N1 = N - N2;
    
    int M = N1 / 64;
    int J = N2;
    double R = x - N *
    4.703593682249706219022922226713490090332925319671630859375e-03;
    
  double y;
  if (R < -3.9946684182723402045667171478271484375000000000000000000000000000000000e-08) {
    if (R < -4.8071224591694772243499755859375000000000000000000000000000000000000000e-04) {
      y = 2.0345950146784148593326335685560479760169982910156250000000000000000000e+00 ; // bf16
      y *= R;
      y += 2.6509489472147071964513997954782098531723022460937500000000000000000000e+00 ;
      y *= R;
      y += 2.3025850929343518735947782261064276099205017089843750000000000000000000e+00 ;
      y *= R;
      y += 9.9999999999999200639422269887290894985198974609375000000000000000000000e-01 ;
    } else {
      y = 2.0342038070938754934502412652364000678062438964843750000000000000000000e+00; // tf32 bf16
      y *= R;
      y += 2.6509490780633422346568295324686914682388305664062500000000000000000000e+00;
      y *= R;
      y += 2.3025850930119302617526955145876854658126831054687500000000000000000000e+00;
      y *= R;
      y += 1.0000000000000006661338147750939242541790008544921875000000000000000000e+00;
    }
  } else {
    if (R < 4.5408678649133671356707964150700718164443969726562500000000000000000000e-04) {
      y = 2.0365512396231335578988819179357960820198059082031250000000000000000000e+00; // tf32 bf16
      y *= R;
      y += 2.6509484286320841306405782233923673629760742187500000000000000000000000e+00;
      y *= R;
      y += 2.3025850930326057230956848798086866736412048339843750000000000000000000e+00;
      y *= R;
      y += 9.9999999999999888977697537484345957636833190917968750000000000000000000e-01;
    } else {
      y = 2.0346310550338824185701014357618987560272216796875000000000000000000000e+00; // bf16
      y *= R;
      y += 2.6509491697211076122187023429432883858680725097656250000000000000000000e+00;
      y *= R;
      y += 2.3025850928811393281137043231865391135215759277343750000000000000000000e+00;
      y *= R;
      y += 1.0000000000000344169137633798527531325817108154296875000000000000000000e+00;
    }
  }
    
    // Perform output compensation
    return y * ldexp(exp2JBy64[J], M);
}
