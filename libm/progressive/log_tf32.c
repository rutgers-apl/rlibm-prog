#include <math.h>
#include "progressive/float_prog_lib.h"
#include "progressive/logconsts.h"

#define LN2HIGH 0.69314718055994528622676398299518041312694549560546875

double rlibm_prog_tf32_log(float x) {
  float_x fix, fit;
  fix.f = x;
  int m = 0;
  
  if (fix.x < 0x800000 || fix.x >= 0x7F800000) {
    if ((fix.x & 0x7FFFFFFF) == 0) return -1.0 / 0.0;
    if (fix.x > 0x7F800000) return 0.0 / 0.0;
    if (fix.x == 0x7F800000) return 1.0 / 0.0;
      
    fix.f *= 8.388608e+06;
    m -= 23;
  }
  
  m += fix.x >> 23;
  m -= 127;
  fix.x &= 0x007FFFFF;
  fix.x |= 0x3F800000;
  
  fit.x = fix.x & 0x007F0000;
  int FIndex = fit.x >> 16;
  fit.x |= 0x3F800000;
  
  double f = fix.f - fit.f;
  f *= log_oneByF[FIndex];
  
  // Find the index of polynomial coefficients
  double_x dX;
  dX.d = f;

  double y;

  if (f < 2.6440349728780020849283616257707762997597455978393554687500000000000000e-03) {
    if (f < 1.3220516251929012238597316297727957135066390037536621093750000000000000e-03) {
      y = -4.9999996989757278242905158549547195434570312500000000000000000000000000e-01; // tf32
      y *= f;
      y += 9.9999999999999178434961777384160086512565612792968750000000000000000000e-01;
      y *= f;
      y += 5.7397185098744507225035963731554964737239529139262086011169516908125843e-42; // bf16
    } else {
      y = -4.9999413218303767614258958928985521197319030761718750000000000000000000e-01; // tf32
      y *= f;
      y += 9.9999999242245973807285963630420155823230743408203125000000000000000000e-01 ;
      y *= f;
      y += 3.6107227598779002301916178075963319402293116855418020350043661892414093e-12 ;  // bf16
    }
  } else {
    if (f < 3.9580345153808595484723475976807094411924481391906738281250000000000000e-03) {
      y = -5.0001043011867118970315004844451323151588439941406250000000000000000000e-01; // tf32
      y *= f;
      y += 1.0000000219880518237403066450497135519981384277343750000000000000000000e+00 ;
      y *= f;
      y += -1.7256267272935349094009673089143274554713158863705757539719343185424805e-11; //bf16
    } else {
      y = -2.4327809727789398430708445175696397200226783752441406250000000000000000e-01; // tf32
      y *= f;
      y += 3.3324475071727344133165615858160890638828277587890625000000000000000000e-01 ;
      y *= f;
      y += -4.9999942981071637815304598007060121744871139526367187500000000000000000e-01;
      y *= f;
      y += 9.9999999820635554481640383528429083526134490966796875000000000000000000e-01 ;
      y *= f;
      y += 2.2061626155188197336519530107529137594526980059583820548141375184059143e-12 ; // bf16
    }
  }
  
  y += ln_lutHIGH[FIndex];
  y += m * LN2HIGH;
  
  return y;
}
