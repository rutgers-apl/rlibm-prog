#include <math.h>
#include "progressive/float_prog_lib.h"
#include "progressive/log10consts.h"

#define LOG102HIGH 0.30102999566398114250631579125183634459972381591796875
#define LOG102LOW  5.27074231034726570126349709198449199648263806413338306011695522101945243775844573974609375e-17

double rlibm_prog_rno_log10(float x) {
  float_x fix, fit;
  fix.f = x;
  int m = 0;

  if (fix.x < 0x800000 || fix.x >= 0x7F800000) {
    if ((fix.x & 0x7FFFFFFF) == 0) { // log(+/-0) = -infty
      fix.x = 0xFF800000;
      return fix.f;
    }
    
    if (fix.x > 0x7FFFFFFF) { // Log(-val) = NaN
      return (x - x) / 0;
        
    }
    
    if (fix.x >= 0x7F800000) {
      return x + x;
    }
    
    fix.f *= 8.388608e+06;
    m -= 23;
  }

  switch (fix.x) {
  case 0x3f800000 : return 0.0;
  case 0x41200000 : return 1.0;
  case 0x42c80000 : return 2.0;
  case 0x447a0000 : return 3.0;
  case 0x461c4000 : return 4.0;
  case 0x47c35000 : return 5.0;
  case 0x49742400 : return 6.0;
  case 0x4b189680 : return 7.0;
  case 0x4cbebc20 : return 8.0;
  case 0x4e6e6b28 : return 9.0;
  case 0x501502f9 : return 10.0;
  }
  
  m += fix.x >> 23;
  m -= 127;
  fix.x &= 0x007FFFFF;
  fix.x |= 0x3F800000;
  
  fit.x = fix.x & 0x007F0000;
  int FIndex = fit.x >> 16;
  fit.x |= 0x3F800000;
  
  double f = fix.f - fit.f;
  f *= log_oneByF[FIndex];
  
  // Find the index of polynomial coefficients
  double_x dX;
  dX.d = f;
  double y;
  
  if (f < 2.6440349728780020849283616257707762997597455978393554687500000000000000e-03) {
    if (f < 1.3220516251929012238597316297727957135066390037536621093750000000000000e-03) {
      y = -9.5737458758581334139492469148535747081041336059570312500000000000000000e-02;
      y *= f;
      y += 1.4473422532229135439862943712796550244092941284179687500000000000000000e-01;
      y *= f;
      y += -2.1714721804400019533609622612857492640614509582519531250000000000000000e-01;
      y *= f;
      y += 4.3429448189781855171887059441360179334878921508789062500000000000000000e-01;
      y *= f;
      y += 5.7397185098744507225035963731554964737239529139262086011169516908125843e-42;
    } else {
      if (f == 2.1962431288257088478343970194828216335736215114593505859375000000000000e-03) {
        y = 9.5276969354843397269627658374702150467783212661743164062500000000000000e-04;
      } else {
        y = -5.5551518313259599934905708096266607753932476043701171875000000000000000e-02;
        y *= f;
        y += 1.4433664158492115481280393396446015685796737670898437500000000000000000e-01;
        y *= f;
        y += -2.1714595350634366410780273781711002811789512634277343750000000000000000e-01;
        y *= f;
        y += 4.3429448020316852030475729407044127583503723144531250000000000000000000e-01;
        y *= f;
        y += 8.3081466905615602384965696866365048728342301842531014699488878250122070e-13;
      }
    }
  } else {
    if (f < 3.9580345153808595484723475976807094411924481391906738281250000000000000e-03) {
      if (f == 3.0116456927675189919613174538426392246037721633911132812500000000000000e-03) {
        y = 1.3059755236534975348511311565857795358169823884963989257812500000000000e-03;
      } else if (f == 3.4018543279059577574829908996889571426436305046081542968750000000000000e-03) {
        y = 1.4748992865482070391269786568955169059336185455322265625000000000000000e-03;
      } else {
        y = -1.5664259492792417916007252642884850502014160156250000000000000000000000e+01;
        y *= f;
        y += 1.7433692284297366836831599812285276129841804504394531250000000000000000e-01;
        y *= f;
        y += 1.4274500054272268312338667328731389716267585754394531250000000000000000e-01;
        y *= f;
        y += -2.1714007878310215282624540122924372553825378417968750000000000000000000e-01;
        y *= f;
        y += 4.3429446929605902694149222043051850050687789916992187500000000000000000e-01;
        y *= f;
        y += 8.8070045801856745760113233236324496115005056040558883978519588708877563e-12;
      }
    } else {
      y = -1.0203950535083713968553809081640793010592460632324218750000000000000000e-01;
      y *= f;
      y += 1.4464587595296235500441639487689826637506484985351562500000000000000000e-01;
      y *= f;
      y += -2.1714633208694333887933680671267211437225341796875000000000000000000000e-01;
      y *= f;
      y += 4.3429447874635246362728935309860389679670333862304687500000000000000000e-01;
      y *= f;
      y += 4.1190149390675119640227696201652783647428890390074229799211025238037109e-12;
    }
  }
  
  
  y += m * LOG102LOW;
  y += log10_lut[FIndex];
  y += m * LOG102HIGH;
  
  return y;
}
